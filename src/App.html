<script>
  import Button from "./components/Button.html";
  import ModalContainer from "./components/ModalContainer.html";

  import api from "./helpers/api.js";
  import circleProps from "./helpers/circleProps.js";

  var map;

  import { places, selectedPlace, message, modalItem } from "./stores.js";

  function drawMap() {
    map = L.map("map")
      .setView(MAP_CENTER, MAP_ZOOM)
      .on("click", onMapClick);

    L.tileLayer("TILE_LAYER", {
      attribution: "TILE_ATTRIBUTION",
      maxZoom: 18
    }).addTo(map);
  }

  function drawPlace(place, recenter) {
    //console.log(place);
    if (!place.lat || !place.long) {
      return;
    }
    var circle = L.circle([place.lat, place.long], circleProps(place))
      .addTo(map)
      .on("click", onMarkerClick);
    if (recenter) {
      map.panTo(new L.LatLng(place.lat, place.long));
    }
  }
  
  function returnToMap() {
    // Clear message:
    message.update(n => null);
    // Clear modal:
    selectedPlace.update(n => null);
    modalItem.update(n => null);
  }

  function onMapClick(e) {
    returnToMap();
  }

  function onMarkerClick(e) {
    // Stop map click event from firing also
    // This is a dumb way to do this but
    // there doesn't seem to be a better way?
    map.off("click", onMapClick);
    setTimeout(function() {
      map.on("click", onMapClick);
    }, 50);
    modalItem.update(n => 'selectedPlace');
    const placeStub = {placeId: e.target.options.placeId}
    selectedPlace.update(n => placeStub);
  }

  function onNewPlaceButtonClick(event) {
    event.target.blur();
    modalItem.update(n => "newPlace");
    selectedPlace.update(n => null)
  }

  (async function main() {
    // Draw the map
    drawMap();
    // Get the places JSON from the api
    const placesApiResponse = await api.getPlaces();
    places.update(n => placesApiResponse);
    // Draw all the places
    for (var i in $places) {
      drawPlace($places[i], false);
    }
  })();
</script>

<ModalContainer
  drawPlace={drawPlace}
  returnToMap={returnToMap}
/>
<span id="new-place-button"><Button label={'New Place'} type={'create'} onClick={onNewPlaceButtonClick} /></span>

<div class="debug">
  <h3>
    {$modalItem}
  </h3>
  <p>
  </p>
</div>

<style>
  #new-place-button {
    z-index: 2;
    position: absolute;
    bottom: 30px;
    right: 20px;
  }
</style>
