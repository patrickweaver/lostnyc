<script>
  import Button from "./components/Button.html";
  import FormContainer from "./components/FormContainer.html";
  import Popup from "./components/Popup.html";

  import api from "./helpers/api.js";
  import circleProps from "./helpers/circleProps.js";

  var map;

  var state = {
    places: [],
    selectedPlace: null,
    form: null
  };

  function drawMap() {
    map = L.map("map")
      .setView(MAP_CENTER, MAP_ZOOM)
      .on("click", onMapClick);

    L.tileLayer("TILE_LAYER", {
      attribution: "TILE_ATTRIBUTION",
      maxZoom: 18
    }).addTo(map);
  }

  function drawPlace(place) {
    if (!place.lat || !place.long) {
      return;
    }
    var circle = L.circle([place.lat, place.long], circleProps(place.placeId))
      .addTo(map)
      .on("click", onMarkerClick);
  }

  async function onMapClick(e) {
    // Clear popup:
    state.selectedPlace = null;
  }

  function onMarkerClick(e) {
    // Stop map click event from firing also
    // This is a dumb way to do this but
    // there doesn't seem to be a better way?
    map.off("click", onMapClick);
    setTimeout(function() {
      map.on("click", onMapClick);
    }, 50);

    // Find clicked on place in places
    for (var i in state.places) {
      if (state.places[i].placeId === e.target.options.placeId) {
        state.selectedPlace = state.places[i];
        break;
      }
    }
  }
  
  function onNewPlaceButtonClick() {
    state.form = 'newPlace'
  }

  (async function main() {
    // Draw the map
    drawMap();
    // Get the places JSON from the api
    state.places = await api.getPlaces();
    // Draw all the places
    for (var i in state.places) {
      drawPlace(state.places[i]);
    }
  })();
</script>

<FormContainer form="{state.form}" />
<Button label={"New Place"} onClick={onNewPlaceButtonClick} />
<Popup {...state.selectedPlace} />

<style></style>
