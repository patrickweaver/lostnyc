<script>
  import { modalItem, selectedPlace } from '../stores.js';
  import fetchOptions from "../helpers/fetchOptions.js";
  import months from "../helpers/months.js";
  
  // subcomponents
  import Memory from './modals/Memory.html';
  import NewFlag from './modals/NewFlag.html';
  import NewMemoryForm from './modals/NewMemory.html';
  import Message from './modals/Message.html';
  import NewPlaceForm from './modals/NewPlace.html';
  import PlaceInfo from './modals/PlaceInfo.html';
  
  export let drawPlace;
  export let returnToMap;
  
  const displayPlaceInfo = '';
  
  function closeForm() {
    if ($selectedPlace && $selectedPlace.name) {
      modalItem.update(n => 'selectedPlace');
    } else {
      returnToMap()
    }
  }
  
  function flagItem(type) {
    modalItem.update(n => type)
  }
  
  function memoryTimestamp(memory) {
    const date = new Date(memory.createdAt)
    const currentYear = (new Date()).getFullYear();
    const year = currentYear === date.getFullYear() ? '' : `, ${date.getFullYear()}`;
    return `on ${months[date.getMonth()]} ${date.getDate()}${year}`;
  }
  
</script>

{#if $modalItem}
  <div id="modal-container">
    
    {#if $modalItem === 'newPlace'}
      <NewPlaceForm
        closeForm={closeForm}
        drawPlace={drawPlace}
      />
    {:else if $modalItem === 'newMemory'}
      <NewMemoryForm
        closeForm={closeForm}
      />
    {:else if $modalItem === 'memory'}
      <Memory
        memoryTimestamp={memoryTimestamp}
      />
    {:else if $modalItem === 'placeFlag' || $modalItem === 'memoryFlag'}
      <NewFlag
        closeForm={closeForm}
      />
    {:else if $modalItem === 'message'}
      <Message returnToMap={returnToMap} />
    
    {:else if $modalItem === 'selectedPlace' && $selectedPlace}
      <PlaceInfo
        closeModal={returnToMap}
        memoryTimestamp={memoryTimestamp}
      />
    {/if}
  
    {#if $modalItem === 'selectedPlace' && $selectedPlace}
      <button class="flag-button text-button" on:click="{() => flagItem('placeFlag')}">
        Click here to flag if this place is wrong or inappropriate.
      </button>
    {:else if $modalItem === 'memory'}
      <button class="flag-button text-button" on:click="{() => flagItem('memoryFlag')}">
        Click here to flag if this memory is inappropriate or on the incorrect place.
      </button>
    {/if}
  </div>
{/if}

<style>
  #modal-container {
    z-index: 100;
    position: absolute;
    top: 0px;
    right: 0px;
    background-color: #eee;
    border: 2px solid black;
    padding: 10px;
    margin: 20px;
    width: Calc(100vw - 40px);
    max-height: Calc(100vh - 40px);
    max-width: 600px;
    min-height: 400px;
    overflow: scroll;
  }
  
  .flag-button {
    position: absolute;
    bottom: 0;
    left: 0;
    margin: 5px;
  }
  
  :global(label), :global(input), :global(textarea) {
    display: block;
    font-size: 18px;
    line-height: 22px;
    width: 100%;
    margin: 3px 0;
  }
  
  :global(textarea) {
    min-height: 6em;
  }
  
  :global(.close-modal) {
    position: absolute;
    top: 0;
    right: 0;
    padding: 10px;
    cursor: pointer;
  }
  
  :global(.text-button) {
    border: none;
    background-color: inherit;
    text-decoration: underline;
    cursor: pointer;
  }
  
  :global(.warning) {
    color: red;
  }
  
  
</style>
