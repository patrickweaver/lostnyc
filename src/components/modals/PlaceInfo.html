<script>
  import { beforeUpdate, afterUpdate } from "svelte";
  import { modalItem, selectedPlace, selectedMemory } from "../../stores.js";

  import Button from "../Button.html";
  import PlaceDetails from "../PlaceDetails.html"
  
  import shortBody from "../../helpers/shortBody.js";
  import api from "../../helpers/api.js";

  export let closeModal;
  export let memoryTimestamp;
  export let recenterOnPlace;
  let update = true;

  beforeUpdate(async () => {
    console.log("beforeUpdate");

    // Get place details:
    if ($selectedPlace.sync) {
      const placeWithMemories = await api.getPlace($selectedPlace.placeId)

      if (!placeWithMemories.error) {
        console.log(new Date());
        placeWithMemories.memories.map(i => shortBody(i));
        selectedPlace.update(n => placeWithMemories);
      } else {
        console.log("ERROR")
        console.log(placeWithMemories.error);
      }
    }
    // Set URL:
    window.location.hash = 'places/' + $selectedPlace.placeId;
  });
  
  afterUpdate(() => {
    console.log("afterUpdate");
    recenterOnPlace($selectedPlace);
  });
  

  function onNewMemoryButtonClick() {
    modalItem.update(n => "newMemory");
    // Don't reset selectedPlace here
  }

  function seeFullMemory(index) {
    selectedMemory.update(n => $selectedPlace.memories[index]);
    modalItem.update(n => "memory");
  }
  
  
</script>

<button class="text-button close-modal" on:click={closeModal}>
  Close
</button>

<div>
  
  <PlaceDetails place={$selectedPlace} />

  <Button label={'New Memory'} type={'create'} onClick={onNewMemoryButtonClick}
  /> {#if $selectedPlace.memories}
  <ul class="memory-list">
    {#each $selectedPlace.memories as memory, index}
    <li class="memory">
      <p>{memory.shortBody}
        <a href="/#memories/{memory.memoryId}" class="text-button" on:click="{() => seeFullMemory(index)}">
          {#if memory.body.length > 240}
            Read More
          {:else}
            <span class="memoryLink">ðŸ”—</span>
          {/if}
        </a>
      </p>
      <p>
        - {#if memory.author}{memory.author}{:else}Anonymous{/if} {memoryTimestamp(memory)}
      </p>
    </li>
    {/each}
  </ul>
  {/if}
</div>

<style>
  
</style>
