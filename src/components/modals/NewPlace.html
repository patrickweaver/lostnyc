<script>
  import Button from "../Button.html";
  import fetchOptions from "../../helpers/fetchOptions.js";

  export let closeForm;
  export let drawPlace;

  import { places, selectedPlace, message, modalItem } from "../../stores.js";

  let placeInput = { state: "NY" };
  let warning;

  async function submitForm(event) {
    event.target.blur();
    if (!placeInput.name || !placeInput.address) {
      warning = "Please add the name and address of the place."
      return;
    }
    if (!placeInput.city) {
      placeInput.city = "DEFAULT_CITY";
    }
    const url = "/api/places/new";
    const options = Object.assign(
      { body: JSON.stringify(placeInput) },
      fetchOptions.post
    );
    var response = await fetch(url, options);
    const responseJson = await response.json();
    addPlace(responseJson);
    if (responseJson.flags) {
      message.update(n => `
        <h2>Thank you for submitting this place</h2>
        <p>Your submission has been flagged for containing inappropriate content. It will be reviewed and posted if it follows our <a href="/terms-of-use" target="_blank">terms of use.</a></p>
      `)
      modalItem.update(n => 'message');
    } else {
      // Go to new place
      selectedPlace.update(n => responseJson);
      modalItem.update(n => 'selectedPlace');
    }
  }
  
  function addPlace(place) {
    places.update(n => {
      n.push(place);
      return n;
    });
    drawPlace(place);
  }
  
  
</script>

<div id="new-place-form" class="form">
  <h1>
    New Place
  </h1>
  {#if warning}
  <p class="warning">
    {warning}
  </p>
  {/if}
  <form autocomplete="off">
    <label>Place Name:</label>
    <input bind:value="{placeInput.name}" type="text" autocomplete="off" />
    <label>Address:</label>
    <input bind:value="{placeInput.address}" type="text" autocomplete="off" />
    <label>City:</label>
    <input bind:value="{placeInput.city}" type="text" autocomplete="off" />
    <label>State:</label>
    <input bind:value="{placeInput.state}" type="text" autocomplete="off" />
    <label>Zip:</label>
    <input bind:value="{placeInput.zip}" type="text" autocomplete="off" />
    <label>Year Opened:</label>
    <input
      bind:value="{placeInput.openYear}"
      min="1800"
      max="2020"
      type="number"
      autocomplete="off"
    />
    <label>Date Closed:</label>
    <input bind:value="{placeInput.closeDate}" type="date" autocomplete="off" />
    <Button label={'Save'} type={'create'} onClick={submitForm} />
    <Button label={'Cancel'} type={'cancel'} onClick={closeForm} />
  </form>
</div>

<style></style>
